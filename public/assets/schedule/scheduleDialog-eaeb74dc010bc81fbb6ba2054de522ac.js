function initFollowDialog(){$("#followEditDialog").dialog({modal:!0,autoOpen:!1,width:800,resizable:!1,open:function(e){openModalDialog()},close:function(e){closeModelDialog()},show:"clip",hide:"clip"}),$("#followExecute").click(function(){followExecute()}),$("#followEditDialog-cancel").click(function(){$("#followEditDialog").dialog("close")})}function initUserGroupDetailDialog(){$("#userGroupDetailDialog").dialog({modal:!0,autoOpen:!1,width:600,resizable:!1,open:function(e){openModalDialog()},close:function(e){closeModelDialog()},show:"clip",hide:"clip"}),$("#userGroupDetailDialog-cancel").click(function(){$("#userGroupDetailDialog").dialog("close")})}function initFacilitiesDetailDialog(){$("#facilitiesDetailDialog").dialog({modal:!0,autoOpen:!1,width:600,resizable:!1,open:function(e){openModalDialog()},close:function(e){closeModelDialog()},show:"clip",hide:"clip"}),$("#facilitiesDetailDialog-cancel").click(function(){$("#facilitiesDetailDialog").dialog("close")})}function initUserDetailDialog(){$("#userDetailDialog").dialog({modal:!0,autoOpen:!1,width:600,resizable:!1,open:function(e){openModalDialog()},close:function(e){closeModelDialog()},show:"clip",hide:"clip"}),$("#userDetailDialog-cancel").click(function(){$("#userDetailDialog").dialog("close")})}function initScheduleDetailDialog(){$("#scheduleDetailDialog").dialog({modal:!0,autoOpen:!1,width:850,resizable:!1,open:function(e){openModalDialog()},close:function(e){closeModelDialog()},show:"clip",hide:"clip"}),$("#moveScheduleEdit").click(function(){$("#scheduleDetailDialog").dialog("close"),openEditDialog($("#scheduleId").val(),"","")}),$("#scheduleDelete").click(function(){scheduleDelete()}),$("#addFollow").click(function(){openFollowEditDialog()}),$("#scheduleDetailDialog-cancel").click(function(){$("#scheduleDetailDialog").dialog("close")})}function scheduleDelete(){if(window.confirm("スケジュールを削除します。本当によろしいですか？")==0)return;var e={};e.schedule_id=$("#scheduleId").val(),e.lock_version=$("#scheduleDetailVersionNo").val(),setToken(e),setAjaxDefault(),$.ajax({type:"POST",data:e,dataType:"json",url:"/ajax/schedule/delete/"}).then(function(e){errorCheck(e),infoCheck(e),$("#scheduleDetailDialog").dialog("close"),refresh()})}function renderScheduleDetailDialog(e){var t=e.schedule;$("#viewDate").text(e.view_date),$("#viewTitle").text(t.title),$("#viewMemo").html(escapeTextArea(t.memo)),$("#userConnList").text(""),$.each(e.schedule_user_conn_list,function(){var e=$("<span />").text(this.value);$("#userConnList").append(e).append("<br />")}),$("#facilitiesConnList").text(""),$.each(e.schedule_facilities_conn_list,function(){var e=$("<span />").text(this.value);$("#facilitiesConnList").append(e).append("<br />")});var n=e.entry_resource_name;n!=""&&(n=n+" ("+e.entry_time+")"),$("#entryUserName").text(n);var r=e.update_resource_name;r!=""&&(r=r+" ("+e.update_time+")"),$("#updateUserName").text(r),$("#scheduleDetailVersionNo").val(t.lock_version),$("#scheduleId").val(t.id)}function initScheduleEditDialog(){$("#scheduleEditDialog").dialog({modal:!0,autoOpen:!1,width:850,resizable:!1,open:function(e){openModalDialog()},close:function(e){closeModelDialog()},show:"clip",hide:"clip"});var e=new Array;e[0]="日曜日",e[1]="月曜日",e[2]="火曜日",e[3]="水曜日",e[4]="木曜日",e[5]="金曜日",e[6]="土曜日",$.datepicker.setDefaults($.extend($.datepicker.regional.ja)),$.timepicker.setDefaults($.extend($.timepicker.regional.ja)),$("#normal_startDate").datepicker(),$("#normal_startTime").timepicker(),$("#normal_startDate").change(function(){changeNormalStartDate()}),$("#normal_endDate").datepicker(),$("#normal_endTime").timepicker(),$("#repeat_startDate").datepicker(),$("#repeat_startTime").timepicker(),$("#repeat_startDate").change(function(){changeRepeatStartDate()}),$("#repeat_endDate").datepicker(),$("#repeat_endTime").timepicker(),$("#repeatWeek").empty();for(var t=0;t<7;t++)$("#repeatWeek").append($("<option>").attr({value:t}).text(e[t]));$("#repeatDay").empty();for(var t=0;t<31;t++){var n=t+1,r="";n<10?r="0"+n:r=""+n,$("#repeatDay").append($("<option>").attr({value:r}).text(t+1+"日"))}$("#repeatDay").append($("<option>").attr({value:32}).text("月末")),$("#repeatEndless").change(function(){changeRepeatStartTimeDisplay()}),$("#userGroupList").change(function(){changeUserGroupList()}),$("#facilitiesGroupList").change(function(){changeFacilitiesGroupList()}),$("#user_up").click(function(){upItems("user_to")}),$("#user_down").click(function(){downItems("user_to")}),$("#user_add").click(function(){addItems("user_from","user_to")}),$("#user_remove").click(function(){removeItems("user_to")}),$("#facilities_up").click(function(){upItems("facilities_to")}),$("#facilities_down").click(function(){downItems("facilities_to")}),$("#facilities_add").click(function(){addItems("facilities_from","facilities_to")}),$("#facilities_remove").click(function(){removeItems("facilities_to")}),$("#scheduleExecute").click(function(){scheduleExecute()}),$("#schedule_type").tabs(),$("#scheduleEditDialog-cancel").click(function(){$("#scheduleEditDialog").dialog("close")})}function changeNormalStartDate(){var e=unFormatDate($("#normal_startDate").val());$("#normal_endDate").val(formatDateyyyyMMdd(e))}function changeRepeatStartDate(){var e=unFormatDate($("#repeat_startDate").val());$("#repeatEndless").attr("checked")==undefined&&$("#repeat_endDate").val(formatDateyyyyMMdd(e))}function scheduleExecute(){var e=createParams();if(validate(e)==0)return;setAjaxDefault(),$.ajax({type:"POST",data:e,dataType:"json",url:"/ajax/schedule/save/"}).then(function(e){if(errorCheck(e)==0&&e.status_code==-1)return;infoCheck(e),$("#scheduleEditDialog").dialog("close"),refresh()})}function createParams(){var e={};e.schedule={};var t=e.schedule;$("#normal_schedule_area").is(".ui-tabs-hide")==0?(e.repeat="0",t.start_date=$("#normal_startDate").val(),t.start_time=unFormatTime($("#normal_startTime").val()),t.end_date=$("#normal_endDate").val(),t.end_time=unFormatTime($("#normal_endTime").val())):(e.repeat="1",t.start_date=$("#repeat_startDate").val(),t.start_time=unFormatTime($("#repeat_startTime").val()),t.end_date=$("#repeat_endDate").val(),t.end_time=unFormatTime($("#repeat_endTime").val()),t.repeat_conditions=$("input[type='radio'][name='repeat_conditions']:checked").val(),t.repeat_week=$("#repeatWeek").val(),t.repeat_day=$("#repeatDay").val(),$("#repeatEndless").attr("checked")==undefined?t.repeat_endless="0":t.repeat_endless="1"),t.id=$("#scheduleId").val(),t.lock_version=$("#scheduleVersionNo").val(),t.title=$("#title").val(),t.memo=$("#memo").val(),t.closed_flg=$("input[type='radio'][name='closedFlg']:checked").val();var n=getSelectArray("user_to"),r=getSelectArray("facilities_to");return e.schedule_conn=n.concat(r),setToken(e),e}function validate(e){var t=new Validate,n=e.schedule;t.addRules({value:n.start_date,option:"required",error_args:"スケジュール開始日"}),t.addRules({value:n.start_date,option:"date",error_args:"スケジュール開始日"}),t.addRules({value:n.start_time,option:"time",error_args:"スケジュール開始時刻"}),t.addRules({value:n.end_date,option:"date",error_args:"スケジュール終了日"}),t.addRules({value:n.end_time,option:"time",error_args:"スケジュール終了時刻"}),t.addRules({value:n.title,option:"required",error_args:"件名"}),t.addRules({value:n.title,option:"maxLength",error_args:"件名",size:64}),t.addRules({value:n.memo,option:"maxLength",error_args:"メモ",size:1024});if(t.execute()==0)return!1;if(n["start_time"]==""&&n["end_time"]!=""||n["start_time"]!=""&&n["end_time"]=="")return alert("時刻を設定する場合はスケジュール開始時刻とスケジュール終了時刻を入力してください。"),!1;if(e["repeat"]=="0"){if(n["end_date"]=="")return alert("スケジュール終了日は必須です。"),!1;if(n.start_date>n.end_date)return alert("終了日は開始日以降の日付を指定して下さい。"),!1;if(n["start_date"]==n["end_date"]&&n["start_time"]!=""&&n.start_time>n.end_time)return alert("終了時刻は開始時刻以降の時間を指定して下さい。"),!1}else{if(n["repeat_endless"]!="1"){if(n["end_date"]=="")return alert("スケジュール終了日は必須です。"),!1;if(n.start_date>n.end_date)return alert("終了日は開始日以降の日付を指定して下さい。"),!1}if(n["start_time"]!=""&&n.start_time>n.end_time)return alert("終了時刻は開始時刻以降の時間を指定して下さい。"),!1}return e["schedule_conn"]==null||e["schedule_conn"].length==0?(alert("スケジュールに紐づくユーザもしくは設備を1件以上設定して下さい。"),!1):!0}function changeUserGroupList(){var e={};e.selected_group_resource=$("#userGroupList").val(),setAjaxDefault(),$.ajax({type:"GET",data:e,url:"/ajax/schedule/get_group_conn_list/"}).then(function(e){if(errorCheck(e)==0)return;setFromResource(e.result,"user_from")})}function changeFacilitiesGroupList(){var e={};e.selected_group_resource=$("#facilitiesGroupList").val(),setAjaxDefault(),$.ajax({type:"GET",data:e,url:"/ajax/schedule/get_group_conn_list/"}).then(function(e){if(errorCheck(e)==0)return;setFromResource(e.result,"facilities_from")})}function changeRepeatStartTimeDisplay(){$("#repeatEndless").attr("checked")==undefined?$("#repeat_endDate").removeAttr("disabled"):$("#repeat_endDate").attr({disabled:"disabled"})}function displayScheduleEditDialogArea(e){e==null||e==""?$("#schedule_type").tabs("select",0):$("#schedule_type").tabs("select",1)}function renderScheduleDialog(e){var t=e.schedule;$("#normal_startDate").val(formatDateyyyyMMdd(t.start_date)),$("#normal_startTime").val(formatTimehhmm(t.start_time)),$("#normal_endDate").val(formatDateyyyyMMdd(t.end_date)),$("#normal_endTime").val(formatTimehhmm(t.end_time));var n=t.repeat_conditions;displayScheduleEditDialogArea(n);if(n==null||n=="")n="1";$("input[type='radio'][name='repeat_conditions']").val([n]),$("#repeat_startDate").val(formatDateyyyyMMdd(t.start_date)),$("#repeat_startTime").val(formatTimehhmm(t.start_time)),$("#repeat_endDate").val(formatDateyyyyMMdd(t.end_date)),$("#repeat_endTime").val(formatTimehhmm(t.end_time)),t.repeat_endless=="1"?$("#repeatEndless").prop("checked",!0):$("#repeatEndless").prop("checked",!1),changeRepeatStartTimeDisplay(),$("#repeatWeek").val(t.repeat_week);var r=t.repeat_day;if(r==null||r=="")r=parseInt(unFormatDate(t.start_date).substring(6),10);$("#repeatDay").val(r),$("#title").val(t.title),$("#memo").val(t.memo);if(t.closed_flg==null||t.closed_flg=="")t.closed_flg="0";$("input[type='radio'][name='closedFlg']").val([t.closed_flg]),$("#user_to").empty(),$.each(e.schedule_user_conn_list,function(){$("#user_to").append($("<option>").attr({value:this.key}).text(this.value))}),reWriteSelect("user_to",new Array),$("#userGroupList").empty(),$.each(e.user_group_list,function(){$("#userGroupList").append($("<option>").attr({value:this.key}).text(this.value))}),$("#userGroupList").val(e.selected_user_group),setFromResource(e.user_group_conn_list,"user_from"),$("#facilities_to").empty(),$.each(e.schedule_facilities_conn_list,function(){$("#facilities_to").append($("<option>").attr({value:this.key}).text(this.value))}),reWriteSelect("facilities_to",new Array),$("#facilitiesGroupList").empty(),$.each(e.facilities_group_list,function(){$("#facilitiesGroupList").append($("<option>").attr({value:this.key}).text(this.value))}),$("#facilitiesGroupList").val(e.selected_facilities_group),setFromResource(e.facilities_group_conn_list,"facilities_from"),$("#scheduleId").val(t.id),$("#scheduleVersionNo").val(t.lock_version),$("#ui-dialog-title-scheduleEditDialog").empty(),$("#scheduleId").val()==""?($("#ui-dialog-title-scheduleEditDialog").append("スケジュール登録"),$("#scheduleExecute").attr({value:"登録する"})):($("#ui-dialog-title-scheduleEditDialog").append("スケジュール変更"),$("#scheduleExecute").attr({value:"変更する"}))}function setFromResource(e,t){$("#"+t).empty(),$.each(e,function(){$("#"+t).append($("<option>").attr({value:this.key}).text(this.value))}),reWriteSelect(t,new Array)}function openEditDialog(e,t,n){var r={};r.schedule_id=e,r.selected_resource_id=t,r.target_date=n,setAjaxDefault(),$.ajax({type:"GET",data:r,url:"/ajax/schedule/get_info/"}).then(function(e){if(errorCheck(e)==0){e.status_code==-6&&refresh();return}var t=e.result;renderScheduleDialog(t),prependDummyText("scheduleEditDialog"),$("#scheduleEditDialog").dialog("open"),removeDummyText("scheduleEditDialog")})}function openDetailDialog(e){var t={};t.schedule_id=e,setAjaxDefault(),$.ajax({type:"GET",data:t,url:"/ajax/schedule/get_info/"}).then(function(e){if(errorCheck(e)==0){e.status_code==-6&&refresh();return}var t=e.result;renderScheduleDetailDialog(t),refreshFollowList().pipe(function(){prependDummyText("scheduleDetailDialog"),$("#scheduleDetailDialog").dialog("open"),removeDummyText("scheduleDetailDialog")})})}function refreshFollowList(){var e={};return e.schedule_id=$("#scheduleId").val(),setAjaxDefault(),$.ajax({type:"GET",data:e,url:"/ajax/schedule/get_schedule_follows/"}).then(function(e){var t=e.result;if(t.length==0){$("#followViewArea").empty();return}var n=$("<h2 />").addClass("title small").text("コメント").css({"margin-top":"1em"}),r=$("<table />").addClass("table table-bordered result_table comment_list_table"),i=$("<tbody />");$.each(t,function(){var e=this.entry_time,t=this.schedule_follow.memo,n=this.schedule_follow.id,r=this.delete_follow,s=this.entry_resource_name,o=$("<input />").attr({type:"button",value:"削"}).addClass("btn btn-danger btn-mini");o.click(function(){deleteFollow(n)});var u=$("<tr />");u.append($("<td />").html(escapeTextArea(t))).append($("<td />").text(s).attr({width:"120px"})).append($("<td />").text(e).attr({width:"100px"})).append($("<td />").append(o).attr({width:"50px"})),i.append(u)}),r.append(i),$("#followViewArea").empty(),$("#followViewArea").append(n).append(r)})}function openFollowEditDialog(){$("#follow_memo").val(""),$("#followEditDialog").dialog("open")}function followExecute(){var e={};e.schedule_follow={};var t=e.schedule_follow;t.schedule_id=$("#scheduleId").val(),t.memo=$("#follow_memo").val(),t.parent_schedule_follow_id="",setToken(e);if(validateFollow(e)==0)return;setAjaxDefault(),$.ajax({type:"POST",data:e,dataType:"json",url:"/ajax/schedule/save_follow/"}).then(function(e){if(errorCheck(e)==0){if(e.status_code==-1)return;closeScheduleAndFollowDialog();return}$("#followEditDialog").dialog("close"),infoCheck(e),refreshFollowList()})}function validateFollow(e){var t=new Validate,n=e.schedule_follow;return t.addRules({value:n.memo,option:"required",error_args:"フォロー"}),t.addRules({value:n.memo,option:"maxLength",error_args:"フォロー",size:1024}),t.execute()}function closeScheduleAndFollowDialog(){$("#followEditDialog").dialog("close"),$("#scheduleDetailDialog").dialog("close"),refresh()}function deleteFollow(e){if(window.confirm("フォローを削除します。本当によろしいですか？")==0)return;var t={};t.schedule_id=$("#scheduleId").val(),t.schedule_follow_id=e,setToken(t),setAjaxDefault(),$.ajax({type:"POST",data:t,dataType:"json",url:"/ajax/schedule/delete_follow/"}).then(function(e){if(errorCheck(e)==0){closeScheduleAndFollowDialog();return}infoCheck(e),refreshFollowList()})}function openScheduleFreeTime(){$("#scheduleFreeTimeForm").empty();var e=getSelectArray("user_to"),t=getSelectedResourceArray("user_from"),n=getSelectArray("facilities_to"),r=getSelectedResourceArray("facilities_from"),i=mergeResource(e,t,n,r);setFreeTimeTargetResourceIdArea(i);var s=setFreeTargetDate(),o=setScheduleFreeTimeViewType(),u={};u.baseDate=s,u.resourceIds=getValues4Name("resourceIds"),u.viewType=o,checkScheduleFreeTimeParam(u)}function checkScheduleFreeTimeParam(e){setAjaxDefault(),$.ajax({type:"POST",data:e,dataType:"json",url:contextPath+"/groupware/scheduleDaily4ResourceAjax/checkData/",success:function(e,t){if(errorCheck(e)==0)return;openScheduleFreeTimeWindow()}})}function openScheduleFreeTimeWindow(){window.open("about:blank","scheduleFreeTime","width=750, height=500, resizable=yes"),$("#scheduleFreeTimeForm").attr({action:contextPath+"/groupware/scheduleDaily4Resource/"}),$("#scheduleFreeTimeForm")[0].submit(function(){return!1})}function setScheduleFreeTimeViewType(){var e="appointment",t=$("<input />").attr({type:"hidden",name:"viewType",value:e});return $("#scheduleFreeTimeForm").append(t),e}function setFreeTargetDate(){var e="";$("#normal_schedule_area").is(".ui-tabs-hide")==0?e=$("#normal_startDate").val():e=$("#repeat_startDate").val();var t=unFormatDate(e),n=formatDateyyyyMMdd(t);if(e==""||t==n){var r=new DateFormat("yyyy/MM/dd");e=r.format(new Date)}e=unFormatDate(e);var i=$("<input />").attr({type:"hidden",name:"baseDate",value:e});return $("#scheduleFreeTimeForm").append(i),e}function setFreeTimeTargetResourceIdArea(e){$.each(e,function(){var e=$("<input />").attr({type:"hidden",name:"resourceIds",value:this});$("#scheduleFreeTimeForm").append(e)})}function mergeResource(e,t,n,r){var i={},s=0;return $.each(e,function(){i[s]=this,s++}),$.each(t,function(){i[s]=this,s++}),$.each(n,function(){i[s]=this,s++}),$.each(r,function(){i[s]=this,s++}),i}$(function(){initScheduleEditDialog(),initScheduleDetailDialog(),initUserDetailDialog(),initFacilitiesDetailDialog(),initUserGroupDetailDialog(),initFollowDialog()});